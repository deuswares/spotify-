<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Backup Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;500;700;900&display=swap');

        :root {
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-surface: rgba(255, 255, 255, 0.03);
            --neon-green: #1DB954;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            overflow-x: hidden;
            direction: ltr; /* Force LTR layout always */
        }
        
        .font-fa { font-family: 'Vazirmatn', sans-serif; }
        .font-zh { font-family: 'Noto Sans SC', sans-serif; }

        /* --- Aurora Background Animation --- */
        .aurora-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgb(29, 185, 84, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgb(80, 50, 200, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 50% 50%, rgb(0, 0, 0) 0%, rgb(10, 10, 10) 100%);
            animation: pulseBg 10s ease-in-out infinite alternate;
        }

        @keyframes pulseBg {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        /* --- Premium Glass Effect --- */
        .glass-card {
            background: var(--glass-surface);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            border-color: var(--neon-green);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 15px rgba(29, 185, 84, 0.2);
        }

        /* --- Buttons --- */
        .btn-primary {
            background: linear-gradient(135deg, #1DB954 0%, #178a3f 100%);
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(29, 185, 84, 0.5);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        /* --- Modal Animation --- */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.3s ease-out; }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-300">

    <div class="aurora-bg"></div>

    <!-- Navigation Bar -->
    <nav class="absolute top-0 w-full p-6 flex justify-between items-center z-20 max-w-7xl mx-auto">
        <div class="flex items-center gap-3">
            <i class="fab fa-spotify text-3xl text-[#1DB954]"></i>
            <span class="font-bold text-xl tracking-wider hidden md:block">BACKUP<span class="text-[#1DB954]">PRO</span></span>
        </div>
        
        <div class="flex gap-3">
            <!-- Help Trigger -->
            <button onclick="toggleHelp()" class="glass-card px-4 py-2 rounded-full flex items-center gap-2 hover:bg-white/10 transition text-sm font-bold">
                <i class="fas fa-question-circle text-[#1DB954]"></i>
                <span data-i18n="nav-help">Help Guide</span>
            </button>

            <!-- Lang Switcher -->
            <div class="relative group">
                <button class="glass-card w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 transition">
                    <i class="fas fa-globe"></i>
                </button>
                <div class="absolute right-0 mt-2 w-32 glass-card rounded-xl overflow-hidden hidden group-hover:block animate-fade-in z-50">
                    <div onclick="setLanguage('en')" class="px-4 py-2 hover:bg-white/10 cursor-pointer text-sm text-left">English</div>
                    <div onclick="setLanguage('fa')" class="px-4 py-2 hover:bg-white/10 cursor-pointer text-sm font-fa text-right">فارسی</div>
                    <div onclick="setLanguage('zh')" class="px-4 py-2 hover:bg-white/10 cursor-pointer text-sm font-zh text-right">中文</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Card -->
    <main class="w-full max-w-2xl relative z-10 mt-16 md:mt-0">
        
        <!-- View 1: Connect -->
        <div id="connect-view" class="glass-card p-8 md:p-12 rounded-3xl transition-all duration-500">
            <div class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black mb-4 tracking-tight" data-i18n="hero-title" dir="auto">Secure Your Music</h1>
                <p class="text-gray-400 text-lg" data-i18n="hero-subtitle" dir="auto">Backup your entire Spotify library into a portable JSON file.</p>
            </div>

            <div class="space-y-6">
                <div class="relative">
                    <label class="block text-xs font-bold text-[#1DB954] uppercase tracking-widest mb-2 ml-1" data-i18n="input-label" dir="auto">Client ID</label>
                    <!-- UPDATED: Changed text-lg to text-base and added placeholder:text-sm -->
                    <input type="text" id="clientId" data-i18n-ph="input-ph" placeholder="Enter your Client ID here..." class="glass-input w-full rounded-2xl p-5 text-white text-base placeholder:text-sm outline-none placeholder-gray-600 font-mono text-left" dir="ltr">
                    <i class="fas fa-key absolute right-5 top-[42px] text-gray-500"></i>
                </div>

                <button onclick="loginSpotifyPKCE()" class="btn-primary w-full py-5 rounded-2xl font-bold text-xl text-white flex items-center justify-center gap-3">
                    <span data-i18n="btn-connect">Connect Spotify</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
                
                <p class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white transition" onclick="toggleHelp()" data-i18n="help-hint" dir="auto">Don't have a Client ID? Click here.</p>
            </div>
        </div>

        <!-- View 2: Backup Dashboard (Hidden) -->
        <div id="dashboard-view" class="glass-card p-8 rounded-3xl hidden transition-all duration-500">
            <!-- User Header -->
            <div class="flex items-center gap-4 mb-8 border-b border-white/10 pb-6">
                <img id="user-avatar" src="" class="w-16 h-16 rounded-full border-2 border-[#1DB954] shadow-[0_0_15px_rgba(29,185,84,0.4)] hidden">
                <div>
                    <div class="text-xs text-gray-400 uppercase tracking-widest" data-i18n="dash-welcome">Welcome Back</div>
                    <div id="user-name" class="text-2xl font-bold text-white">User</div>
                </div>
                <div class="ml-auto flex gap-2">
                    <div class="text-center bg-white/5 p-2 rounded-lg min-w-[80px]">
                        <div class="text-xs text-gray-400" data-i18n="stat-list">Playlists</div>
                        <div id="playlist-count" class="font-bold text-[#1DB954] text-xl">0</div>
                    </div>
                </div>
            </div>

            <!-- Action Area -->
            <div class="space-y-4">
                <div id="console-log" class="bg-black/40 rounded-xl p-4 h-48 overflow-y-auto font-mono text-xs text-green-400/80 border border-white/5 shadow-inner text-left" dir="ltr">
                    <span class="text-gray-600">>> System Ready...</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="start-btn" onclick="startBackup()" class="btn-secondary py-4 rounded-xl font-bold text-white flex items-center justify-center gap-2 hover:bg-[#1DB954]/20 hover:border-[#1DB954]">
                        <i class="fas fa-play"></i> <span data-i18n="btn-start">Start Backup</span>
                    </button>
                    <button id="download-btn" onclick="downloadJSON()" class="bg-white/5 text-gray-500 py-4 rounded-xl font-bold cursor-not-allowed flex items-center justify-center gap-2 border border-transparent" disabled>
                        <i class="fas fa-download"></i> <span data-i18n="btn-download">Download JSON</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Help Modal (Overlay) -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 text-left" dir="ltr">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleHelp()"></div>
        <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-3xl relative z-10 p-8 modal-enter">
            <button onclick="toggleHelp()" class="absolute top-6 right-6 text-gray-400 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                <i class="fas fa-book-open text-[#1DB954]"></i>
                <span data-i18n="guide-title" dir="auto">Setup Guide</span>
            </h2>

            <div class="space-y-8">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1DB954]/20 text-[#1DB954] flex items-center justify-center font-bold text-lg border border-[#1DB954]/50">1</div>
                    <div class="w-full">
                        <h3 class="font-bold text-lg mb-2" data-i18n="step1-title" dir="auto">Go to Developer Dashboard</h3>
                        <p class="text-gray-400 text-sm mb-2" data-i18n="step1-desc" dir="auto">Log in to Spotify's developer portal and click "Create App".</p>
                        <a href="https://developer.spotify.com/dashboard" target="_blank" class="inline-flex items-center gap-2 text-[#1DB954] text-sm hover:underline">
                            developer.spotify.com <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1DB954]/20 text-[#1DB954] flex items-center justify-center font-bold text-lg border border-[#1DB954]/50">2</div>
                    <div class="w-full">
                        <h3 class="font-bold text-lg mb-2" data-i18n="step2-title" dir="auto">Set Redirect URI (Critical)</h3>
                        <p class="text-gray-400 text-sm mb-3" data-i18n="step2-desc" dir="auto">Copy this EXACT link and paste it into the "Redirect URIs" field in your app settings.</p>
                        
                        <div class="relative group">
                            <code id="redirect-display" class="block w-full bg-black/50 border border-white/10 rounded-lg p-3 font-mono text-xs text-gray-300 break-all">...</code>
                            <button onclick="copyRedirect()" class="absolute right-2 top-2 bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-xs text-white transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1DB954]/20 text-[#1DB954] flex items-center justify-center font-bold text-lg border border-[#1DB954]/50">3</div>
                    <div class="w-full">
                        <h3 class="font-bold text-lg mb-2" data-i18n="step3-title" dir="auto">Get Client ID</h3>
                        <p class="text-gray-400 text-sm" data-i18n="step3-desc" dir="auto">Copy the "Client ID" from your dashboard settings and paste it into the main screen of this app.</p>
                    </div>
                </div>

                <div class="bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-xl flex items-start gap-3">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-yellow-500 text-sm">Example Config</h4>
                        <p class="text-xs text-yellow-200/70 mt-1">Name: My Backup<br>Redirect URI: <span class="font-mono text-white/50">YOUR_PAGE_URL</span></p>
                    </div>
                </div>
            </div>

            <button onclick="toggleHelp()" class="w-full mt-8 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm transition" data-i18n="btn-got-it">I Understand</button>
        </div>
    </div>

    <script>
        // --- Internationalization (I18n) ---
        const translations = {
            en: {
                'nav-help': 'Setup Guide',
                'hero-title': 'Secure Your Music',
                'hero-subtitle': 'Backup your entire Spotify library into a portable JSON file.',
                'input-label': 'Client ID',
                'input-ph': 'Enter Client ID from Spotify Dashboard...',
                'btn-connect': 'Connect Spotify',
                'help-hint': "Don't have a Client ID? Click here.",
                'guide-title': 'Setup Guide',
                'step1-title': 'Create App',
                'step1-desc': 'Log in to Spotify Dashboard and create a new app.',
                'step2-title': 'Set Redirect URI',
                'step2-desc': 'Copy this EXACT link into your App Settings > Redirect URIs.',
                'step3-title': 'Get Client ID',
                'step3-desc': 'Copy the Client ID and paste it on the home screen.',
                'btn-got-it': 'Got it, let\'s go!',
                'dash-welcome': 'Welcome Back',
                'stat-list': 'Playlists',
                'btn-start': 'Start Backup',
                'btn-download': 'Download JSON',
                'log-ready': 'System Ready...',
                'log-start': 'Initializing backup sequence...',
                'log-fetch': 'Fetching playlist index...',
                'log-item': 'Processing: ',
                'log-done': 'Backup complete. Ready to download.',
                'alert-copy': 'Redirect URI copied to clipboard!'
            },
            fa: {
                'nav-help': 'راهنمای نصب',
                'hero-title': 'موسیقی‌ات را حفظ کن',
                'hero-subtitle': 'از تمام پلی‌لیست‌های اسپاتیفای خود یک نسخه پشتیبان JSON بگیرید.',
                'input-label': 'شناسه کلاینت (Client ID)',
                'input-ph': 'شناسه را از داشبورد اسپاتیفای وارد کنید...',
                'btn-connect': 'اتصال به اسپاتیفای',
                'help-hint': 'شناسه کلاینت ندارید؟ اینجا کلیک کنید.',
                'guide-title': 'راهنمای راه‌اندازی',
                'step1-title': 'ساخت اپلیکیشن',
                'step1-desc': 'وارد داشبورد اسپاتیفای شوید و یک App جدید بسازید.',
                'step2-title': 'تنظیم آدرس بازگشت (مهم)',
                'step2-desc': 'این لینک را دقیقاً کپی کنید و در بخش Redirect URIs تنظیمات قرار دهید.',
                'step3-title': 'دریافت Client ID',
                'step3-desc': 'کد Client ID را کپی کنید و در صفحه اصلی این برنامه وارد کنید.',
                'btn-got-it': 'متوجه شدم',
                'dash-welcome': 'خوش آمدید',
                'stat-list': 'پلی‌لیست',
                'btn-start': 'شروع بکاپ‌گیری',
                'btn-download': 'دانلود فایل JSON',
                'log-ready': 'سیستم آماده است...',
                'log-start': 'آغاز فرآیند پشتیبان‌گیری...',
                'log-fetch': 'در حال دریافت لیست پلی‌لیست‌ها...',
                'log-item': 'پردازش: ',
                'log-done': 'بکاپ کامل شد. آماده دانلود.',
                'alert-copy': 'لینک کپی شد!'
            },
            zh: {
                'nav-help': '设置指南',
                'hero-title': '保护您的音乐',
                'hero-subtitle': '将您的 Spotify 音乐库备份为便携式 JSON 文件。',
                'input-label': '客户端 ID (Client ID)',
                'input-ph': '在此处输入客户端 ID...',
                'btn-connect': '连接 Spotify',
                'help-hint': '没有客户端 ID？点这里。',
                'guide-title': '设置指南',
                'step1-title': '创建应用',
                'step1-desc': '登录 Spotify 仪表板并创建一个新应用。',
                'step2-title': '设置重定向 URI (关键)',
                'step2-desc': '复制此确切链接并将其粘贴到应用设置的 Redirect URIs 字段中。',
                'step3-title': '获取客户端 ID',
                'step3-desc': '复制 Client ID 并将其粘贴到主屏幕上。',
                'btn-got-it': '明白了，开始吧！',
                'dash-welcome': '欢迎回来',
                'stat-list': '播放列表',
                'btn-start': '开始备份',
                'btn-download': '下载 JSON',
                'log-ready': '系统就绪...',
                'log-start': '初始化备份序列...',
                'log-fetch': '正在获取播放列表索引...',
                'log-item': '正在处理：',
                'log-done': '备份完成。准备下载。',
                'alert-copy': '重定向 URI 已复制！'
            }
        };

        // --- Core Logic ---
        let currentLang = localStorage.getItem('sp_lang') || 'en';
        let accessToken = null;
        let allData = { user: {}, playlists: [] };

        // Helper: Get Clean URL
        const getRedirectUri = () => window.location.href.split('?')[0].split('#')[0];

        // Init
        window.onload = async () => {
            setLanguage(currentLang);
            document.getElementById('redirect-display').textContent = getRedirectUri();
            
            // Restore Client ID
            const savedId = localStorage.getItem('sp_client_id');
            if(savedId) document.getElementById('clientId').value = savedId;

            // Handle Auth Return
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) await handleAuthCode(code);
        };

        // UI Functions
        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            const content = modal.querySelector('div.modal-enter');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => content.classList.add('modal-enter-active'), 10);
            } else {
                content.classList.remove('modal-enter-active');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
        }

        function copyRedirect() {
            navigator.clipboard.writeText(getRedirectUri());
            const btn = document.querySelector('button[onclick="copyRedirect()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.add('text-green-400');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('text-green-400');
            }, 2000);
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('sp_lang', lang);
            document.documentElement.lang = lang;
            
            // REMOVED: document.body.dir = ... to keep layout fixed
            
            // Update Fonts
            document.body.classList.remove('font-fa', 'font-zh');
            if(lang === 'fa') document.body.classList.add('font-fa');
            if(lang === 'zh') document.body.classList.add('font-zh');

            // Update Texts
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if(translations[lang][key]) el.placeholder = translations[lang][key];
            });
        }

        function t(key) { return translations[currentLang][key] || key; }

        function log(msg, type = 'info') {
            const console = document.getElementById('console-log');
            const div = document.createElement('div');
            div.className = `mb-1 ${type === 'error' ? 'text-red-400' : 'text-green-400/80'}`;
            div.innerHTML = `> ${msg}`;
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
        }

        // --- PKCE Auth Flow ---
        async function loginSpotifyPKCE() {
            const clientId = document.getElementById('clientId').value.trim();
            if (!clientId) return alert("Please enter Client ID");
            
            localStorage.setItem('sp_client_id', clientId);
            
            const verifier = generateRandomString(128);
            const challenge = await generateCodeChallenge(verifier);
            localStorage.setItem('pkce_verifier', verifier);

            const params = new URLSearchParams({
                response_type: 'code',
                client_id: clientId,
                scope: 'user-read-private playlist-read-private playlist-read-collaborative user-library-read',
                redirect_uri: getRedirectUri(),
                code_challenge_method: 'S256',
                code_challenge: challenge
            });

            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function handleAuthCode(code) {
            window.history.pushState({}, document.title, window.location.pathname);
            document.getElementById('connect-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.querySelector('nav').classList.add('hidden'); // Hide nav for cleaner view

            const clientId = localStorage.getItem('sp_client_id');
            const verifier = localStorage.getItem('pkce_verifier');

            try {
                const res = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: clientId,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: getRedirectUri(),
                        code_verifier: verifier
                    })
                });

                if(!res.ok) throw new Error('Token Failed');
                const data = await res.json();
                accessToken = data.access_token;
                
                // Fetch User
                const userRes = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const user = await userRes.json();
                allData.user = user;
                
                document.getElementById('user-name').innerText = user.display_name;
                if(user.images?.[0]) {
                    document.getElementById('user-avatar').src = user.images[0].url;
                    document.getElementById('user-avatar').classList.remove('hidden');
                }

            } catch (e) {
                console.error(e);
                alert("Auth Error. Check Client ID/Redirect URI.");
                location.href = getRedirectUri();
            }
        }

        // --- Backup Logic ---
        async function startBackup() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            
            log(t('log-start'));

            try {
                // Fetch Playlists
                log(t('log-fetch'));
                const playlists = await fetchAll('https://api.spotify.com/v1/me/playlists?limit=50');
                document.getElementById('playlist-count').innerText = playlists.length;

                // Fetch Tracks
                for(const pl of playlists) {
                    log(`${t('log-item')} ${pl.name}...`);
                    const tracks = await fetchAll(pl.tracks.href);
                    
                    allData.playlists.push({
                        info: { name: pl.name, id: pl.id, desc: pl.description },
                        tracks: tracks.map(t => ({
                            name: t.track?.name,
                            artist: t.track?.artists.map(a => a.name).join(', '),
                            album: t.track?.album.name,
                            uri: t.track?.uri
                        })).filter(t => t.name)
                    });
                }

                log(t('log-done'));
                const dlBtn = document.getElementById('download-btn');
                dlBtn.disabled = false;
                dlBtn.classList.remove('cursor-not-allowed', 'bg-white/5', 'text-gray-500');
                dlBtn.classList.add('btn-primary', 'text-white');

            } catch (e) {
                log(`Error: ${e.message}`, 'error');
                btn.disabled = false;
            }
        }

        async function fetchAll(url) {
            let items = [];
            let next = url;
            while(next) {
                const res = await fetch(next, { headers: { 'Authorization': 'Bearer ' + accessToken } });
                if(res.status === 429) {
                    const wait = res.headers.get('Retry-After') || 2;
                    log(`Rate limit! Waiting ${wait}s...`, 'error');
                    await new Promise(r => setTimeout(r, wait * 1000));
                    continue;
                }
                const data = await res.json();
                items.push(...data.items);
                next = data.next;
            }
            return items;
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spotify_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        // Crypto Utils
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
            return text;
        }
        async function generateCodeChallenge(v) {
            const d = new TextEncoder().encode(v);
            const h = await crypto.subtle.digest('SHA-256', d);
            return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        }
    </script>
</body>
</html>
